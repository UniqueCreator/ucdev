<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
  <!--UsingTask AssemblyFile="..\src\tools\bin\x86\debug\uc_build_tasks_d.dll" TaskName="UniqueCreator.Build.Tasks.Animation" /-->
  <UsingTask AssemblyFile="..\..\src\tools\bin\x86\release\uc_build_tasks_r.dll" TaskName="UniqueCreator.Build.Tasks.Animation" />
  
  <PropertyGroup>
    <AutoGeneratedAnimations Condition="$(AutoGeneratedAnimations) == ''">Generated Files\$(Platform)\$(ProjectName)\data\animations\</AutoGeneratedAnimations>
  </PropertyGroup>

  <PropertyGroup>
    <AnimationToolPath>..\src\tools\bin\x64\release</AnimationToolPath>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <Animation>
        <TrackerLogDirectory Condition="$(TLogLocation)== ''">$(IntermediateOutputPath)</TrackerLogDirectory>
        <InputAnimation>%(FileName)</InputAnimation>
        <OutputAnimation>$(AutoGeneratedAnimations)%(FileName).animation</OutputAnimation>
        <InProject>true</InProject>
        <MinimalRebuildFromTracking>true</MinimalRebuildFromTracking>
    <Name>noname</Name>
    </Animation>

  </ItemDefinitionGroup>

  <Target Name="UCDEVMakeDirsForAnimations">

    <ItemGroup Condition="'@(Animation)'!=''">
      <AnimationOutputs Include="@(Animation->Metadata('OutputAnimation')->Distinct())" />
      <AnimationOutputs Include="$(TLogLocation)$(ProjectName).read.1.tlog"/>
      <AnimationOutputs Include="$(TLogLocation)$(ProjectName).write.1.tlog"/>
      <AnimationDirsToMake Include="@(AnimationOutputs->DirectoryName())" />
    </ItemGroup>

    <MakeDir Directories="@(AnimationDirsToMake)" />

    <ItemGroup>
      <AnimationDirsToMake Remove="@(AnimationDirsToMake)" />
    </ItemGroup>
  </Target>

  <Target Name="UCDevGenerateAnimations" DependsOnTargets="UCDEVMakeDirsForAnimations" Condition="'@(Animation)' != ''">

    <PropertyGroup>
        <TrackerLogDirectory              Condition="'%(Animation.TrackerLogDirectory)'              == ''">$(TLogLocation)</TrackerLogDirectory>
        <MinimalRebuildFromTracking       Condition="'%(Animation.MinimalRebuildFromTracking)'       == ''">true</MinimalRebuildFromTracking>
        <TrackFileAccess                  Condition="'%(Animation.TrackFileAccess)'                  == ''">true</TrackFileAccess>
    </PropertyGroup>
    
    <Animation
      Source                          ="@(Animation)"
      OutputAnimation                 ="%(Animation.OutputAnimation)"
      OptionsSwapYZ                   ="%(Animation.OptionsSwapYZ)"
      OptionMakeLeftHanded            ="%(Animation.OptionMakeLeftHanded)"

      TrackFileAccess                 ="$(TrackFileAccess)"
      MinimalRebuildFromTracking      ="$(MinimalRebuildFromTracking)"
      TrackerLogDirectory             ="$(TrackerLogDirectory)"
      ToolPath                        ="$(AnimationToolPath)"
    >
    <Output TaskParameter="OutputAnimation" ItemName="BinaryAnimations" />
    </Animation>
    
    <ItemGroup>
      <BinaryAnimations>
        <DeploymentContent>True</DeploymentContent>
        <Link>$([MSBuild]::MakeRelative($(TargetDir), appdata/animations/%(Filename)%(Extension)))</Link>
      </BinaryAnimations>
    </ItemGroup>

    <ItemGroup>
      <None Include="@(BinaryAnimations);" />
    </ItemGroup>
 
  </Target>

  <PropertyGroup>
      <BuildDependsOn>
      UCDevGenerateAnimations;
      $(BuildDependsOn)
      </BuildDependsOn>
  </PropertyGroup>

</Project>