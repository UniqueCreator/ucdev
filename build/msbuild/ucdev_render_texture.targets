<?xml version="1.0" encoding="utf-8"?>

<Project DefaultTargets="Build" ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask AssemblyFile="..\..\src\tools\bin\x86\release\uc_build_tasks_r.dll" TaskName="UniqueCreator.Build.Tasks.Texture" />

  <PropertyGroup>
    <AutoGeneratedTextures Condition="$(AutoGeneratedTextures) == ''">Generated Files\$(Platform)\$(ProjectName)\data\textures\</AutoGeneratedTextures>
  </PropertyGroup>

  <PropertyGroup>
    <TextureToolPath>..\src\tools\bin\x64\release</TextureToolPath>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <Texture>
        <TrackerLogDirectory Condition="$(TLogLocation)== ''">$(IntermediateOutputPath)</TrackerLogDirectory>
        <InputTexture>%(FileName)</InputTexture>
        <OutputTexture>$(AutoGeneratedTextures)%(FileName)</OutputTexture>
        <OutputTextureFormat/>
        <InProject>true</InProject>
        <MinimalRebuildFromTracking>true</MinimalRebuildFromTracking>
    </Texture>
  </ItemDefinitionGroup>

  <Target Name="UCDEVMakeDirsForTextures">
    <ItemGroup Condition="'@(Texture)'!=''">
      <TextureOutputs Include="@(Texture->Metadata('OutputTexture')->Distinct())" />
      <TextureOutputs Include="$(TLogLocation)$(ProjectName).read.1.tlog"/>
      <TextureOutputs Include="$(TLogLocation)$(ProjectName).write.1.tlog"/>
      <TextureDirsToMake Include="@(TextureOutputs->DirectoryName())" />
    </ItemGroup>

    <MakeDir Directories="@(TextureDirsToMake)" />

    <ItemGroup>
      <ShaderDirsToMake Remove="@(TextureDirsToMake)" />
    </ItemGroup>
  </Target>

  <Target Name="UCDevGenerateTextures" DependsOnTargets="UCDEVMakeDirsForTextures" Condition="'@(Texture)' != ''">

    <PropertyGroup>
        <TrackerLogDirectory              Condition="'%(Texture.TrackerLogDirectory)'              == ''">$(TLogLocation)</TrackerLogDirectory>
        <MinimalRebuildFromTracking       Condition="'%(Texture.MinimalRebuildFromTracking)'       == ''">true</MinimalRebuildFromTracking>
        <TrackFileAccess                  Condition="'%(Texture.TrackFileAccess)'              == ''">true</TrackFileAccess>
    </PropertyGroup>
    
    <Texture
      Source                          ="@(Texture)"
      OutputTexture                   ="%(Texture.OutputTexture).texture"
      OutputTextureFormat             ="%(Texture.OutputTextureFormat)"
      
      TrackFileAccess                 ="$(TrackFileAccess)"
      MinimalRebuildFromTracking      ="$(MinimalRebuildFromTracking)"
      TrackerLogDirectory             ="$(TrackerLogDirectory)"
      ToolPath                        ="$(TextureToolPath)"
    >
    <Output TaskParameter="OutputTexture" ItemName="BinaryTextures" />
    </Texture>
    
    <ItemGroup>
      <BinaryTextures>
        <DeploymentContent>True</DeploymentContent>
        <Link>$([MSBuild]::MakeRelative($(TargetDir), appdata/textures/%(Filename)%(Extension)))</Link>
      </BinaryTextures>
    </ItemGroup>

    <ItemGroup>
      <None Include="@(BinaryTextures);" />
    </ItemGroup>
 
  </Target>

    <PropertyGroup>
      <BuildDependsOn>
      UCDevGenerateTextures;
      $(BuildDependsOn)
      </BuildDependsOn>
  </PropertyGroup>

</Project>