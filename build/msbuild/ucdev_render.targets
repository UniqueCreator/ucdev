<?xml version="1.0" encoding="utf-8"?>

<Project DefaultTargets="Build" ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!--UsingTask AssemblyFile="..\..\src\tools\bin\x86\debug\uc_build_tasks_d.dll" TaskName="UniqueCreator.Build.Tasks.HLSLCompiler" /-->
  <!--UsingTask AssemblyFile="..\..\src\tools\bin\x86\debug\uc_build_tasks_d.dll" TaskName="UniqueCreator.Build.Tasks.GraphicsPipelineStateObject" /-->
  <!--UsingTask AssemblyFile="..\..\src\tools\bin\x86\debug\uc_build_tasks_d.dll" TaskName="UniqueCreator.Build.Tasks.ComputePipelineStateObject" /-->

  <PropertyGroup>
    <ToolsBaseDirectory Condition="$(ToolsBaseDirectory)==''">..\src\tools\</ToolsBaseDirectory>
  </PropertyGroup>

  <UsingTask AssemblyFile="..\..\src\tools\bin\x86\release\uc_build_tasks_r.dll" TaskName="UniqueCreator.Build.Tasks.HLSLCompiler" />
  <UsingTask AssemblyFile="..\..\src\tools\bin\x86\release\uc_build_tasks_r.dll" TaskName="UniqueCreator.Build.Tasks.GraphicsPipelineStateObject" />
  <UsingTask AssemblyFile="..\..\src\tools\bin\x86\release\uc_build_tasks_r.dll" TaskName="UniqueCreator.Build.Tasks.ComputePipelineStateObject" />

  <PropertyGroup>
    <AutoGeneratedShaders Condition="$(AutoGeneratedShaders) == ''">autogen\$(Platform)\$(ProjectName)\autogen\shaders\</AutoGeneratedShaders>
    <AutoGeneratedGraphicsPipelineStateObjects Condition="$(AutoGeneratedGraphicsPipelineStateObjects) == ''">autogen\$(Platform)\$(ProjectName)\autogen\shaders\</AutoGeneratedGraphicsPipelineStateObjects>
    <AutoGeneratedComputePipelineStateObjects Condition="$(AutoGeneratedComputePipelineStateObjects) == ''">autogen\$(Platform)\$(ProjectName)\autogen\shaders\</AutoGeneratedComputePipelineStateObjects>
  </PropertyGroup>

  <PropertyGroup>
  <PsoToolPath>$(ToolsBaseDirectory)bin\x64\release</PsoToolPath>
  </PropertyGroup>

  <ItemDefinitionGroup>
      <Shader>
        <TrackerLogDirectory Condition="$(TLogLocation)== ''">$(IntermediateOutputPath)</TrackerLogDirectory>
        <ShaderPipelineStage></ShaderPipelineStage>
        <CPPGeneratedTypeName>%(FileName)</CPPGeneratedTypeName>
        <PDBFile>$(AutoGeneratedShaders)%(FileName)%(Extension).dxbc.pdb</PDBFile>
        <DXBC>$(AutoGeneratedShaders)%(FileName)%(Extension).dxbc</DXBC>
        <DXBCHeader>$(AutoGeneratedShaders)%(FileName)%(Extension).dxbc.h</DXBCHeader>
        <DXBCVariableName></DXBCVariableName>
        <CPPGeneratedTypeName>%(FileName)</CPPGeneratedTypeName>
        <InProject>true</InProject>
        <MinimalRebuildFromTracking>true</MinimalRebuildFromTracking>
        <CPPGeneratedFileName>$(AutoGeneratedShaders)%(CPPGeneratedTypeName).cpp</CPPGeneratedFileName>
        <CPPGeneratedFileNameHeader>$(AutoGeneratedShaders)%(CPPGeneratedTypeName).h</CPPGeneratedFileNameHeader>
        <Backend>UniqueCreatorDev</Backend>
      </Shader>
  </ItemDefinitionGroup>

  <Target Name="UCDEVMakeDirsForShaders">

    <ItemGroup Condition="'@(Shader)'!=''">
      <ShaderOutputs Include="@(Shader->Metadata('DXBC')->Distinct())" />
      <ShaderOutputs Include="@(Shader->Metadata('DXBCHeader')->Distinct())"/>
      <ShaderOutputs Include="@(Shader->Metadata('CPPGeneratedFileName')->Distinct())"/>
      <ShaderOutputs Include="@(Shader->Metadata('CPPGeneratedFileNameHeader')->Distinct())"/>
      <ShaderOutputs Include="@(Shader->Metadata('PDBFile')->Distinct())"/>
      <ShaderOutputs Include="$(TLogLocation)$(ProjectName).read.1.tlog"/>
      <ShaderOutputs Include="$(TLogLocation)$(ProjectName).write.1.tlog"/>
      <ShadersDirsToMake Include="@(ShaderOutputs->DirectoryName())" />
    </ItemGroup>

    <MakeDir Directories="@(ShadersDirsToMake)" />

    <ItemGroup>
      <ShaderDirsToMake Remove="@(ShadersDirsToMake)" />
    </ItemGroup>
  </Target>

  <Target Name="UCDevGenerateShaders" DependsOnTargets="UCDEVMakeDirsForShaders">

    <PropertyGroup>
      <TrackerLogDirectory              Condition="'%(Shader.TrackerLogDirectory)'              == ''">$(TLogLocation)</TrackerLogDirectory>
      <MinimalRebuildFromTracking       Condition="'%(Shader.MinimalRebuildFromTracking)'       == ''">true</MinimalRebuildFromTracking>
      <TrackFileAccess Condition="'$(TrackFileAccess)' == ''">true</TrackFileAccess>
    </PropertyGroup>

    <HLSLCompiler 
        Sources="@(Shader)"
        StateFile="$(IntermediateOutputPath)$(MSBuildProjectFile).HLSLCompiler.Cache" 
        ToolPath="$(ToolsBaseDirectory)bin\fxc\"
        TrackerLogDirectory = "$(TrackerLogDirectory)"
        AdditionalIncludeDirectories= "%(Shader.AdditionalIncludeDirectories)"
        PreprocessorDefinitions = "%(Shader.PreprocessorDefinitions)"
        GeneratedCodeBackend = "%(Shader.Backend)"
     >
        <Output TaskParameter="FilesWritten"         ItemName="FileWrites" />
        <Output TaskParameter="CPPFiles"             ItemName="ClCompile" />
        <Output TaskParameter="CPPFilesHeaders"      ItemName="ClInclude" />

    </HLSLCompiler>

  </Target>
  
  <ItemDefinitionGroup>
      <GraphicsPipelineStateObject>
        <TrackerLogDirectory Condition="$(TLogLocation)== ''">$(IntermediateOutputPath)</TrackerLogDirectory>
        <CPPHeaderOutput>$(AutoGeneratedGraphicsPipelineStateObjects)</CPPHeaderOutput>
        <CPPOutput>$(AutoGeneratedGraphicsPipelineStateObjects)</CPPOutput>
          <InProject>true</InProject>
            <MinimalRebuildFromTracking>true</MinimalRebuildFromTracking>
      </GraphicsPipelineStateObject>
  </ItemDefinitionGroup>

  <Target Name="UCDEVMakeDirsForGraphicsPSO" Condition="'@(GraphicsPipelineStateObject)' != ''">

    <ItemGroup Condition="'@(GraphicsPipelineStateObject)'!=''">
      <PSOOutputs Include="@(GraphicsPipelineStateObject->Metadata('CPPHeaderOutput')->Distinct())" />
      <PSOOutputs Include="@(GraphicsPipelineStateObject->Metadata('CPPOutput')->Distinct())" />
      <PSOOutputs Include="$(TLogLocation)$(ProjectName).read.1.tlog"/>
      <PSOOutputs Include="$(TLogLocation)$(ProjectName).write.1.tlog"/>
      <PSODirsToMakeGraphics Include="@(ShaderOutputs->DirectoryName())" />
    </ItemGroup>

    <MakeDir Directories="@(PSODirsToMakeGraphics)" />

    <ItemGroup>
      <PSODirsToMakeGraphics Remove="@(PSODirsToMakeGraphics)" />
    </ItemGroup>
  </Target>

  <Target Name="UCDevGenerateGraphicsPSO" DependsOnTargets="UCDEVMakeDirsForGraphicsPSO" Condition="'@(GraphicsPipelineStateObject)' != ''">

    <PropertyGroup>
      <TrackerLogDirectory              Condition="'%(GraphicsPipelineStateObject.TrackerLogDirectory)'              == ''">$(TLogLocation)</TrackerLogDirectory>
      <MinimalRebuildFromTracking       Condition="'%(GraphicsPipelineStateObject.MinimalRebuildFromTracking)'       == ''">true</MinimalRebuildFromTracking>
      <TrackFileAccess                  Condition="'%(GraphicsPipelineStateObject.TrackFileAccess)'                  == ''">true</TrackFileAccess>
    </PropertyGroup>

    <GraphicsPipelineStateObject
        Source                                  ="@(GraphicsPipelineStateObject)"
        EntryPointName                      ="%(GraphicsPipelineStateObject.EntryPointName)"
        CPPOutput                             ="%(GraphicsPipelineStateObject.CPPOutput)%(GraphicsPipelineStateObject.EntryPointName).cpp"
        CPPHeaderOutput                     ="%(GraphicsPipelineStateObject.CPPHeaderOutput)%(GraphicsPipelineStateObject.EntryPointName).h"
        TrackFileAccess                     ="$(TrackFileAccess)"
        MinimalRebuildFromTracking    ="$(MinimalRebuildFromTracking)"
        TrackerLogDirectory           ="$(TrackerLogDirectory)"
        ToolPath                                ="$(PsoToolPath)"
        GeneratedCodeBackend            = "%(GraphicsPipelineStateObject.Backend)"
     >
        <Output TaskParameter="CPPOutput"            ItemName="ClCompile" />
        <Output TaskParameter="CPPHeaderOutput"      ItemName="ClInclude" />
    </GraphicsPipelineStateObject>

  </Target>

  <ItemDefinitionGroup>
      <ComputePipelineStateObject>
        <TrackerLogDirectory Condition="$(TLogLocation)== ''">$(IntermediateOutputPath)</TrackerLogDirectory>
        <CPPHeaderOutput>$(AutoGeneratedComputePipelineStateObjects)</CPPHeaderOutput>
        <CPPOutput>$(AutoGeneratedComputePipelineStateObjects)</CPPOutput>
        <InProject>true</InProject>
        <MinimalRebuildFromTracking>true</MinimalRebuildFromTracking>
      </ComputePipelineStateObject>
  </ItemDefinitionGroup>

  <Target Name="UCDEVMakeDirsForComputePSO" Condition="'@(ComputePipelineStateObject)' != ''">

    <ItemGroup Condition="'@(ComputePipelineStateObject)'!=''">
      <PSOOutputs Include="@(Compute->Metadata('CPPHeaderOutput')->Distinct())" />
      <PSOOutputs Include="@(Compute->Metadata('CPPOutput')->Distinct())" />
      <PSOOutputs Include="$(TLogLocation)$(ProjectName).read.1.tlog"/>
      <PSOOutputs Include="$(TLogLocation)$(ProjectName).write.1.tlog"/>
      <PSODirsToMakeCompute Include="@(ShaderOutputs->DirectoryName())" />
    </ItemGroup>

    <MakeDir Directories="@(PSODirsToMakeCompute)" />

    <ItemGroup>
      <PSODirsToMakeCompute Remove="@(PSODirsToMakeCompute)" />
    </ItemGroup>
  </Target>

  <Target Name="UCDevGenerateComputePSO" DependsOnTargets="UCDEVMakeDirsForComputePSO" Condition="'@(ComputePipelineStateObject)' != ''">
 
  <PropertyGroup>
      <TrackerLogDirectory              Condition="'%(ComputePipelineStateObject.TrackerLogDirectory)'              == ''">$(TLogLocation)</TrackerLogDirectory>
      <MinimalRebuildFromTracking       Condition="'%(ComputePipelineStateObject.MinimalRebuildFromTracking)'       == ''">true</MinimalRebuildFromTracking>
      <TrackFileAccess                  Condition="'%(ComputePipelineStateObject.TrackFileAccess)'                  == ''">true</TrackFileAccess>
  </PropertyGroup>

    <ComputePipelineStateObject
    Source                      ="@(ComputePipelineStateObject)"
    EntryPointName              ="%(ComputePipelineStateObject.EntryPointName)"
    CPPOutput                   ="%(ComputePipelineStateObject.CPPOutput)%(ComputePipelineStateObject.EntryPointName).cpp"
    CPPHeaderOutput             ="%(ComputePipelineStateObject.CPPHeaderOutput)%(ComputePipelineStateObject.EntryPointName).h"
    TrackFileAccess             ="$(TrackFileAccess)"
    MinimalRebuildFromTracking  ="$(MinimalRebuildFromTracking)"
    TrackerLogDirectory         ="$(TrackerLogDirectory)"
    ToolPath                    ="$(PsoToolPath)"
    GeneratedCodeBackend        ="%(ComputePipelineStateObject.Backend)"
     >
        <Output TaskParameter="CPPOutput"            ItemName="ClCompile" />
        <Output TaskParameter="CPPHeaderOutput"      ItemName="ClInclude" />
    </ComputePipelineStateObject>

  </Target>


  <PropertyGroup>
      <BuildDependsOn>
      UCDevGenerateShaders;
      UCDevGenerateGraphicsPSO;
      UCDevGenerateComputePSO;
      $(BuildDependsOn)
      </BuildDependsOn>
  </PropertyGroup>

</Project>