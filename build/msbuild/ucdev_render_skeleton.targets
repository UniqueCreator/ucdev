<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="14.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <UsingTask AssemblyFile="..\..\src\tools\bin\x86\release\uc_build_tasks_r.dll" TaskName="UniqueCreator.Build.Tasks.Skeleton" />

  <PropertyGroup>
  <AutoGeneratedSkeletons Condition="$(AutoGeneratedSkeletons) == ''">Generated Files\$(Platform)\$(ProjectName)\data\skeletons\</AutoGeneratedSkeletons>
  </PropertyGroup>

  <PropertyGroup>
  <SkeletonToolPath>..\src\tools\bin\x64\release</SkeletonToolPath>
  </PropertyGroup>

  <ItemDefinitionGroup>
    <Skeleton>
        <TrackerLogDirectory Condition="$(TLogLocation)== ''">$(IntermediateOutputPath)</TrackerLogDirectory>
        <InputSkeleton>%(FileName)</InputSkeleton>
        <OutputSkeleton>$(AutoGeneratedSkeletons)%(FileName).skeleton</OutputSkeleton>
        <InProject>true</InProject>
        <MinimalRebuildFromTracking>true</MinimalRebuildFromTracking>
    <Name>noname</Name>
    </Skeleton>

  </ItemDefinitionGroup>

  <Target Name="UCDEVMakeDirsForSkeletons">

    <ItemGroup Condition="'@(Skeleton)'!=''">
      <SkeletonOutputs Include="@(Skeleton->Metadata('OutputSkeleton')->Distinct())" />
      <SkeletonOutputs Include="$(TLogLocation)$(ProjectName).read.1.tlog"/>
      <SkeletonOutputs Include="$(TLogLocation)$(ProjectName).write.1.tlog"/>
      <SkeletonDirsToMake Include="@(SkeletonOutputs->DirectoryName())" />
    </ItemGroup>

    <MakeDir Directories="@(SkeletonDirsToMake)" />

    <ItemGroup>
      <SkeletonDirsToMake Remove="@(SkeletonDirsToMake)" />
    </ItemGroup>
  </Target>

  <Target Name="UCDevGenerateSkeletons" DependsOnTargets="UCDEVMakeDirsForSkeletons" Condition="'@(Skeleton)' != ''">

    <PropertyGroup>
        <TrackerLogDirectory              Condition="'%(Skeleton.TrackerLogDirectory)'              == ''">$(TLogLocation)</TrackerLogDirectory>
        <MinimalRebuildFromTracking       Condition="'%(Skeleton.MinimalRebuildFromTracking)'       == ''">true</MinimalRebuildFromTracking>
        <TrackFileAccess                  Condition="'%(Skeleton.TrackFileAccess)'                  == ''">true</TrackFileAccess>
    </PropertyGroup>
    
    <Skeleton
      Source                          ="@(Skeleton)"
      OutputSkeleton                  ="%(Skeleton.OutputSkeleton)"
      OptionsSwapYZ                   ="%(Skeleton.OptionsSwapYZ)"
      OptionMakeLeftHanded            ="%(Skeleton.OptionMakeLeftHanded)"

      TrackFileAccess                 ="$(TrackFileAccess)"
      MinimalRebuildFromTracking      ="$(MinimalRebuildFromTracking)"
      TrackerLogDirectory             ="$(TrackerLogDirectory)"
      ToolPath                        ="$(SkeletonToolPath)"
    >
    <Output TaskParameter="OutputSkeleton" ItemName="BinarySkeletons" />
    </Skeleton>
    
    <ItemGroup>
      <BinarySkeletons>
        <DeploymentContent>True</DeploymentContent>
        <Link>$([MSBuild]::MakeRelative($(TargetDir), appdata/skeletons/%(Filename)%(Extension)))</Link>
      </BinarySkeletons>
    </ItemGroup>

    <ItemGroup>
      <None Include="@(BinarySkeletons);" />
    </ItemGroup>
 
  </Target>

  <PropertyGroup>
      <BuildDependsOn>
      UCDevGenerateSkeletons;
      $(BuildDependsOn)
      </BuildDependsOn>
  </PropertyGroup>

</Project>